name: Prepare Build

on:
  workflow_call

permissions:
  contents: read

jobs:
  cache-dlls:
    runs-on: windows-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@8ca2b8b2ece13480cda6dacd3511b49857a23c09 # v2.5.1
        with:
          egress-policy: audit

      - name: Restore Neos DLL Cache
        id: cache-neos-dlls
        uses: actions/cache/restore@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # v3.3.1
        with:
          path: |
            ExternalLibraries/BaseX.dll
            ExternalLibraries/CloudX.Shared.dll
            ExternalLibraries/CodeX.dll
          key: neos-dlls
          enableCrossOsArchive: true
      - name: Download Neos
        if: steps.cache-neos-dlls.outputs.cache-hit != 'true'
        shell: pwsh
        run: Invoke-WebRequest -Uri "https://assets.neos.com/install/Pro/Data/2022.1.28.1310_YTDLP.7z" -OutFile Neos.7z
      - name: Extract Neos
        if: steps.cache-neos-dlls.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          7z x -y Neos.7z -oNeos
          del Neos.7z
      - name: Relocate DLLS
        if: steps.cache-neos-dlls.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          mkdir ExternalLibraries
          mv Neos/Neos_Data/Managed/BaseX.dll ExternalLibraries/
          mv Neos/Neos_Data/Managed/CloudX.Shared.dll ExternalLibraries/
          mv Neos/Neos_Data/Managed/CodeX.dll ExternalLibraries/
      - name: Save Needed DLLs to Cache
        if: steps.cache-neos-dlls.outputs.cache-hit != 'true'
        id: save-cache
        uses: actions/cache/save@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # v3.3.1
        with:
          path: |
            ExternalLibraries/BaseX.dll
            ExternalLibraries/CloudX.Shared.dll
            ExternalLibraries/CodeX.dll
          key: neos-dlls
          enableCrossOsArchive: true
